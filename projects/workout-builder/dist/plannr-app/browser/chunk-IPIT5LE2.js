import{a as d}from"./chunk-E2KADIVF.js";import{$a as g,D as a,Ta as m,c as h,cb as p,i as l,k as f,m as u,z as c}from"./chunk-IYJWUTWN.js";var s=class extends Error{};s.prototype.name="InvalidTokenError";function $(r){return decodeURIComponent(atob(r).replace(/(.)/g,(t,n)=>{let e=n.charCodeAt(0).toString(16).toUpperCase();return e.length<2&&(e="0"+e),"%"+e}))}function j(r){let t=r.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return $(t)}catch{return atob(t)}}function b(r,t){if(typeof r!="string")throw new s("Invalid token specified: must be a string");t||(t={});let n=t.header===!0?0:1,e=r.split(".")[n];if(typeof e!="string")throw new s(`Invalid token specified: missing part #${n+1}`);let i;try{i=j(e)}catch(o){throw new s(`Invalid token specified: invalid base64 for part #${n+1} (${o.message})`)}try{return JSON.parse(i)}catch(o){throw new s(`Invalid token specified: invalid json for part #${n+1} (${o.message})`)}}var w=(()=>{let t=class t{constructor(){this.inactiveSubject$=new h}startListening(e){let i=b(e);if(!i.exp)throw Error("Error decoding jwt");let o=Math.floor(Date.now()/1e3),k=i.exp-o;this.startTimer(k)}waitForLogout(){return this.inactiveSubject$.asObservable()}startTimer(e){this.timer$&&this.timer$.unsubscribe(),this.timer$=l(1e3).subscribe(i=>{i%240||console.log(`${((e-i)/60).toFixed(2)}min until logout`),i>e&&(this.inactiveSubject$.next(!0),this.inactiveSubject$.complete(),this.timer$?.unsubscribe())})}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=c({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();var S=(()=>{let t=class t{getToken(){return localStorage.getItem("token")}initToken(e){this.setToken(e)}clearToken(){localStorage.removeItem("token")}setToken(e){localStorage.setItem("token",e)}listenForActivity(){}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=c({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();var H=(()=>{let t=class t{constructor(){this.http=a(m),this.jwtService=a(S),this.router=a(g),this.inactivityService=a(w),this.notificationsService=a(d)}login$(e,i){return this.http.post(p.url+"/auth/login",{email:e,password:i}).pipe(u(o=>{this.jwtService.initToken(o.token),this.router.navigate(["/exercises"]),this.inactivityService.startListening(o.token),this.waitForLogout()}),f(o=>{throw this.notificationsService.open({type:"error",message:o.error.message||o.message}),o}))}register$(e,i){return this.http.post(p.url+"/auth/register",{email:e,password:i}).pipe(u(o=>{o&&this.router.navigate(["/login"])}))}logout(){this.router.navigate(["/login"]),this.jwtService.clearToken()}waitForLogout(){this.logoutSub$&&this.logoutSub$.unsubscribe(),this.logoutSub$=this.inactivityService.waitForLogout().subscribe(e=>{e&&(this.logout(),this.logoutSub$?.unsubscribe())})}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=c({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();export{w as a,S as b,H as c};
